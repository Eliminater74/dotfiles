#!/bin/sh

## TODO
# Check for git

ask() {
    printf %b "$1 [y/n] "
    read -r REPLY
    echo
}

clone() {
    (cd "$HOME/repos" && git clone "$1")
}

cat <<'EOF'
 ____   ___ _____ _____ ___ _     _____ ____
|  _ \ / _ \_   _|  ___|_ _| |   | ____/ ___|
| | | | | | || | | |_   | || |   |  _| \___ \
| |_| | |_| || | |  _|  | || |___| |___ ___) |
|____/ \___/ |_| |_|   |___|_____|_____|____/

You are installing Andrea Feletto's dotfiles.

EOF

echo 'Checking for the distro...'
distroName="$(grep '^NAME=' /etc/os-release | cut -d= -f2 | tr -d '"')"
echo "You are running $distroName"
distroId="$(grep '^ID=' /etc/os-release | cut -d= -f2 | tr -d '"')"
if [ "$distroId" != 'arch' ]; then
    echo 'This script is not garanteed to work in non-arch distros.'
    ask 'Would you like to continue anyway?'
    [ "$REPLY" != 'y' ] && exit 0
fi
echo

echo 'Checking for Git...'
if command -v git >/dev/null; then
    echo 'Git is installed.'
else
    echo 'Git is not installed.'
    ask 'Would you like to continue anyway?'
    [ "$REPLY" != 'y' ] && exit 0
fi
echo

printf 'Stowing the following directories:\n'
folders="$(find . -maxdepth 1 -type d | cut -d/ -f2 | grep -v '^\.')"
echo "$folders" | column
echo

echo 'Creating directories before stowing...'
for folder in $folders; do
    find "$folder" -mindepth 1 -type d | sed "s:^$folder:$HOME:" | xargs -r mkdir -p
done
printf 'Done\n\n'

echo 'Stowing...'
echo "$folders" | xargs stow
printf 'Done\n\n'

echo 'Now is the time to logout and login again.'
ask 'Is this what you just did?'
[ "$REPLY" != 'y' ] && exit 0

ask 'Do you wish to update the system and install pacman packages?'
[ "$REPLY" = 'y' ] && grep -v "#" pkgs-arch | sudo pacman -Syu --needed - 2>/dev/null
echo

ask 'Do you wish to install ruby packages?'
[ "$REPLY" = 'y' ] && xargs -a pkgs-gem gem install
echo

ask 'Do you wish to install python packages?'
[ "$REPLY" = 'y' ] && grep -v "#" pkgs-python | sudo pacman -Syu --needed - 2>/dev/null
echo

ask 'Do you wish to install npm packages?'
[ "$REPLY" = 'y' ] && xargs -a pkgs-npm npm i -g
echo

ask 'Do you wish to install github packages?'
if [ "$REPLY" = 'y' ]; then
    mkdir -p "$HOME/repos"
    for name in st dmenu dwm slock; do
        printf '\n\n%b\n\n' "Installing $name from GitHub..."
        clone "https://github.com/andreafeletto/$name.git" 2>/dev/null
        (cd "$HOME/repos/$name" && sudo make install clean)
        echo 'Done'
    done
fi
echo

ask "Do you wish to install aur packages?"
if [ "$REPLY" = 'y' ]; then
    while read -r name; do
        printf '\n%b\n\n' "Installing $name from the AUR..."
        pacman -Q "$name" && echo "$name already installed. Skipping." && continue
        clone "https://aur.archlinux.org/$name.git" 2>/dev/null
        (cd "$HOME/repos/$name" && makepkg -si)
    done < pkgs-aur
fi
echo

ask "Do you wish to install Rust?"
if [ "$REPLY" = 'y' ]; then
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
    mv "$HOME/.cargo" "$HOME/.local/cargo"
    mv "$HOME/.rustup" "$HOME/.local/rustup"
fi
echo

ask "Do you wish to install systemd services?"
[ "$REPLY" = 'y' ] && xargs -a services sudo systemctl enable --now
echo

